<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Lyngo</title>
	<style>
		html, body { background-color: black;color: white; text-align: center; font-family: Verdana, Sans;}
		.word-wrapper { display:flex; justify-content:center; align-items:center; flex-wrap: wrap }
		.word-wrapper span {display: inline-block;line-height: 80px; font-size: 4em; font-weight:  bold; margin: 0.2em; width: 80px; height:  80px; background-color: #666;}
		span.ok { background-color:#090; }
		span.notok { background-color: #222; color: #666 }
		span.place { background-color: #f33; }
	</style>
</head>
<body>
	<h2>Lyngo - Trova la parola!</h2>
	<h6>Digita le lettere per trovare la parola.</h6>
	<p>Legenda lettere: <strong><span class="ok">&nbsp;Al&nbsp;posto&nbsp;giusto&nbsp;</span> <span class="place">&nbsp;Presente&nbsp;</span> <span class="notok">&nbsp;Non&nbsp;c'Ã¨&nbsp;</span></strong></p>
	<hr/>
<script>
let tries = 0;
let currentIndex = 1;
let globalIndex = 1;
let wordLength = 0;

window.scrollTo({
	top: 0,
	behavior: 'smooth'
});


async function getWord(word) {
  // Default options are marked with *
  let more = word === undefined ? '': `?word=${word}`;
  let response = await fetch(`getWord.php${more}`);
  let result = await response.json(); // parses JSON response into native JavaScript objects
  return word === undefined ? result.word.toUpperCase().split('') : result.corretta;
}

function createWordWrapper(){
	const newDiv = document.createElement("div");
	newDiv.classList.add('word-wrapper');
	document.body.appendChild(newDiv);
	return newDiv;
}

function addLetter (appendTo) {
  // create a new div element
  const newDiv = document.createElement("span");

  // and give it some content
  const newContent = document.createTextNode('');
  newDiv.setAttribute("id", globalIndex++);

  // add the text node to the newly created div
  newDiv.appendChild(newContent);

  // add the newly created element and its content into the DOM
  appendTo.appendChild(newDiv);
}


getWord().then((word) =>{
	for(let i=0; i<word.length+1; i++)
		writeCells(word)
	globalIndex--;
	handleWord(word);
})


function handleWord(word){
	//console.log(globalIndex);
	wordLength = word.length;
	tries++;
	let ih = window.innerHeight;
	let et = document.getElementById(currentIndex).offsetTop;
	console.log(et,ih);
	if( et >= ih-106){
		let top = (et-ih)+106;
		
		window.scrollTo({
			top: top,
			behavior: 'smooth'
		});
		
	}
	window.addEventListener('keyup', function handler(event){
		if(event.keyCode == 8){
			if(currentIndex != 1 && (currentIndex-1)%wordLength != 0){
				currentIndex--;
				let target = document.getElementById(currentIndex);
				target.innerHTML = '';
				return;
			}
		}
		if(event.keyCode < 65 || event.keyCode > 90)
			return;
		let letter = event.key.toUpperCase();;
		let target = document.getElementById(currentIndex);
		target.innerHTML = letter;
		if( currentIndex%wordLength == 0){
			window.removeEventListener('keyup', handler);
			checkWord(word);
		} else{
			currentIndex++;
		}
	});
}

function writeCells(word){
	let appendTo = createWordWrapper();

	word.forEach((letter) => {
		addLetter(appendTo)
	});
}

function check(typed,word){
	let letters = {
		word: [...word],
		typed: [...typed]
	}

	letters.typed.forEach((letter,i) => {
		if(letter === letters.word[i]){
			letters.typed[i] = 1;
			letters.word[i] = null;
		} 
	});

	let tword = [...letters.word]
	
	letters.typed.forEach((letter,i) => {
		let ti = tword.indexOf(letter);

		if(ti >= 0){
			letters.typed[i]= -1;
			tword[ti] = null;
		}
		
	})
	
	letters.typed = letters.typed.map(el => isNaN(el) ? null : el);
	return letters.typed;
}

function checkWord(word){
	let typed = [];
	for(let i = currentIndex - wordLength + 1; i<= currentIndex; i++){
		typed.push(document.getElementById(i).innerHTML);
	}
	getWord(typed.join('')).then((corretta) => {
		if(!corretta){
			alert("Parola inesistente!");
			for(let j=0; j<wordLength; j++){
				document.getElementById(currentIndex).innerHTML = '';
				currentIndex--;
			}
			currentIndex++;
			handleWord(word);
			return;
		}
		let checkResult = check(typed,word);

		//console.log(checkResult);
		let found = 0;

		for(let pos=0,i = currentIndex - wordLength + 1; i<= currentIndex; i++, pos++){
		
			let target = document.getElementById(i);
			
			switch(checkResult[pos]){
				case 1:
					target.classList.add("ok");
					found++;
					break;
				case -1:
					target.classList.add("place");
					break;
				case null:
					target.classList.add("notok");
					break;
			}
		
		}
			
		if(found == wordLength){
			setTimeout(() => {
				alert(`Bravo, ce l'hai fatta con ${tries} tentativi!`);
				location.reload();
			},500);
			return;
		}


		currentIndex++;
		if(currentIndex > globalIndex){
			setTimeout(() => {
				alert(`Hai perso, la parola era ${word.join('')}`);
				location.reload();
			},500);
			return;
		}
		
		handleWord(word);

	});
	
}
</script>
</body>
</html>